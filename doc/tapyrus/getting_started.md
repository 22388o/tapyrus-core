## Introduction

As Tapyrus is a *federated network*, multiple main networks overseen by one federation each would be online. Each network could be using Tapyrus to deploy a blockchain application for use in a different context. A network can be identified by looking at the network parameters namely the genesis block, aggregate public key and network magic bytes upto version v0.3.0. Before running a node double check the network parameters and make sure that the node connects to the right network.


### Components of a Tapyrus network
Tapyrus network has different kinds of nodes, this is a minimal list at the time of release:

| Node type |    How many? | Purpose |
| :---: | :---: | :---: |
|Tapyrus Signer | min 3, max 15  | A network of signers that collects Unapproved transactions from the Tapyrus network and creates a block. |
| Tapyrus Core  | min 1, unbounded  | Tapyrus full node implementation |
| Tapyrus Seeder | min 1, unbounded  | DNS seeder for configuring Tapyrus network |

### Tapyrus network parameters
Following parameters are unique to each tapyrus network

**Genesis block**  
In Tapyrus, genesis block is not embedded into the software. It is an external file generated using a utility provided by Tapyrus called Tapyrus-genesis and signed by the federation of Tapyrus-signers. Each Tapyrus network has a unique genesis block. 

**Aggregate public key**  
The genesis block contains the "aggregate public key" of the federation. It is generated by the Tapyrus-signer network at startup using verifiable secret sharing scheme. It is used by each Tapyrus-core node to validate the threshold signature in the block proof and accept the block.

**Network magic bytes**  
Magic bytes are used as a way to identify the separate network messages sent between nodes on the Tapyrus network. The list of available networks and their magic bytes is in [Network ID and Magic Bytes](https://github.com/chaintope/tapyrus-core/blob/v0.3.0/doc/tapyrus/network_id_and_magic_bytes.md)

## FAQ
* [How to build tapyrus?](https://github.com/chaintope/tapyrus-core/blob/v0.3.0/doc/tapyrus/getting_started.md#how-to-build-tapyrus)
* [How to get the pre-built binaries?](https://github.com/chaintope/tapyrus-core/blob/v0.3.0/doc/tapyrus/getting_started.md#how-to-get-the-pre-built-binaries)
* [How to start tapyrus in regtest mode?](https://github.com/chaintope/tapyrus-core/blob/v0.3.0/doc/tapyrus/getting_started.md#how-to-start-tapyrus-in-regtest-mode)
* [How to start a node on tapyrus testnet?](https://github.com/chaintope/tapyrus-core/blob/v0.3.0/doc/tapyrus/getting_started.md#how-to-start-a-node-on-tapyrus-testnet)
* [How to start a new tapyrus network?](https://github.com/chaintope/tapyrus-core/blob/v0.3.0/doc/tapyrus/getting_started.md#how-to-start-a-new-tapyrus-network)
* [How to create a genesis block?](https://github.com/chaintope/tapyrus-core/blob/v0.3.0/doc/tapyrus/getting_started.md#how-to-create-a-genesis-block)
* [How to get coins?](https://github.com/chaintope/tapyrus-core/blob/v0.3.0/doc/tapyrus/getting_started.md#how-to-get-coins)
* [How to upgrade tapyrus?](https://github.com/chaintope/tapyrus-core/blob/v0.3.0/doc/tapyrus/getting_started.md#how-to-upgrade-tapyrus)


## How to build tapyrus? 

Tapyrus is currently supported on two platforms, Linux and Mac Os. 
- To build tapyrus-core  
Please follow the instructions in [build-unix.md](..//build-unix.md) and [build-osx.md](../build-osx.md) to build tapyrus-core components
- To build tapyrus-signer   
Please follow the instructions in [build tapyrus-signer](https://github.com/chaintope/tapyrus-signer#building-the-source) to build tapyrus-signer

## How to get the pre-built binaries?

Pre-built Tapyrus binaries for the supported platforms namely Linux and Mac os are packaged from version 0.3.0 onwards.
* v.0.3.0 [TODO:add link]

- The package contains all the binaries needed to create a Tapyrus network and release notes. 
- Binaries for older versions and other platforms need to be built from the source code. Please note that they have not been tested and are not guaranteed to work as expected.

## How to start tapyrus in regtest mode?

One Tapyrus-core node can be started in regtest mode for testing purposes. 
1. Create data directory. It is recommended to use a different data directory for each mode/network.
```$ sudo mkdir /var/lib/tapyrus-regtest```

2. Create a configuration file 'tapyrus.conf' with the following content
```
regtest=1
[regtest]
port=12858
rpcport=17858
server=1
keypool=1
discover=0
bind=127.0.0.1
```

3. Choose an elliptic curve private key and public key pair. These keys would serve as the 'aggregate public key' and 'aggregate private key' in regtest mode.

4. Generate a new **signed genesis block** using tapyrus-genesis utility. Aggregate public key and its corresponsing private key are needed as command line options to generate a signed genesis block.
Read [Create new genesis block using tapyrus-genesis-utility](https://github.com/chaintope/tapyrus-core/blob/v0.3.0/doc/tapyrus/getting_started.md#how-to-create-a-genesis-block)
 section for more details.
``` 
./tapyrus-genesis -regtest -time=1563342688 -address=mmtAurzUTURFq9MSizWyj5sAkWzgqR8PBn -signblockpubkey=03af80b90d25145da28c583359beb47b21796b2fe1a23c1511e443e7a64dfdb27d -signblockprivatekey=cUJN5RVzYWFoeY8rUztd47jzXCu1p57Ay8V7pqCzsBD3PEXN7Dd4
```
##### :heavy_exclamation_mark:Caution
> Tapyrus-genesis utility can generate a genesis block with a valid block proof. It is not recommended to use this feature in other modes. This feature should be used for testing only.

5. Start Tapyrus-core node with -regtest option
```/usr/local/bin/tapyrusd -regtest -datadir=/var/lib/tapyrus-regtest -conf=/etc/tapyrus/tapyrus.conf```

6. Import the private key into the wallet you plan to use for testing. Use _'importaddress'_ and _'importprivkey'_ RPCs to use the default wallet provided by Tapyrus-core. 

7. Generate new blocks using _'generatetoaddress'_ RPC when using external wallet. _'generatetoaddress'_ or _'generate'_ RPC when using the default wallet. Tapyrus-core does not have the capability to generate blocks on its own. It relies on Tapyrus-signer network for block creation. In order to generate blocks in regtest mode these RPCs need to be used.
```
tapyrus-cli -regtest -datadir=/var/lib/tapyrus-regtest -conf=/etc/tapyrus/tapyrus.conf -rpcport=17858 generatetoaddress 1 \"mmtAurzUTURFq9MSizWyj5sAkWzgqR8PBn\" \"c87509a1c067bbde78beb793e6fa76530b6382a4c0241e5e4a9ec0a0f44dc0d3\"
```
##### :heavy_exclamation_mark:Caution
> generate and generatetoaddress RPCs can generate blocks with valid block proofs. Do not use these RPCs in other modes when the signer network is active as the node could diverge.

Block rewards can now be spent to create new transactions and proceed with testing.

## How to start a node on Tapyrus testnet?

##### Note:
> :point_right: If you wish to start a new test network then follow the instructions in [How to start a new tapyrus network?](https://github.com/chaintope/tapyrus-core/blob/v0.3.0/doc/tapyrus/getting_started.md#how-to-start-a-new-tapyrus-network) and run Tapyrus-core (tapyrusd) with -testnet option.

Remember that Tapyrus testnet is deployed and can be verified using the following command:  
```$ tapyrus-cli -testnet -rpcconnect=54.65.133.45 -rpcuser=user -rpcpassword=pass getblockchaininfo```

In order to join the testnet it is enough to start a Tapyrus-core node (tapyrusd) on the host. Please follow the steps below to add a node to tapyrus testnet. 

1. Create data directory. It is recommended to use a different data directory for each mode/network.
```$ sudo mkdir /var/lib/tapyrus-testnet```

2. Create a configuration file 'tapyrus.conf' with the following content

```
testnet=3
txindex=1
server=1
rest=1
rpcuser=user
rpcpassword=pass
rpcbind=0.0.0.0
rpcallowip=172.16.2.0/24
```

3. Create 'genesis.dat' in data dir with the following content. This is the genesis block of the testnet

TODO:update this file after testnet is reset for version 0.3.0.
```
0100000000000000000000000000000000000000000000000000000000000000000000002e4533a0ccb1c1b83a641ce00656d3d234e362ab2ce0d6d69eaaba1edceb9e962f69b65cb127339d5d8da08d50f6d4deb37b46157123dbe5fb0a30a641af68e70c3d285d0346304402201e9de308c52cfc760c9eb5a1638857563c39791a77bd3b4c53dcd26b4d02e8480220542963fe20dbedd31c609f8393cb68e4b80c4e849fcddf7a0a2dddaac4ce2e134630440220295288205c39d933dd7c236011857cf3b0147e226154afc5c44421a38cb0a77102202c580fdf814904ed3f17fce8f545ba66aa3ebd9a00eb7205371ee3de895e2a0346304402200f9301b705c64a5fb5cb9ecb8cf4498291142b93491cb560e36db6145f60d6e002200572b51df4e1397340a1487f9f8b35e07730055a2d4d9a83e0954ff22a8bc599010100000001000000000000000000000000000000000000000000000000000000000000000000000000240102210276d7a1b83fd97b8751d2b82e1f7a89dcd23a5b3f5cc2798083ad6f775018102effffffff0100f2052a010000001976a914a941c2ccebe78a5a1348dddd42362b588cb563b588ac00000000
```

4. Before running, it's recommended that you create an RPC configuration file.

```
echo -e "rpcuser=bitcoinrpc\nrpcpassword=$(xxd -l 16 -p /dev/urandom)" > "/Users/${USER}/Library/Application Support/Tapyrus/tapyrus.conf"

chmod 600 "/Users/${USER}/Library/Application Support/Tapyrus/tapyrus.conf"
```


5. Start 'tapyrusd' using the following command.

```/usr/local/bin/tapyrusd -testnet -daemon -datadir=/var/lib/tapyrus-testnet -conf=/etc/tapyrus/tapyrus.conf```


Verify the progress of initial block download in the new node using debug.log. The node is ready to accept transactions which would be written to the testnet blockchain. Please refer to [how to get coins](https://github.com/chaintope/tapyrus-core/blob/v0.3.0/doc/tapyrus/getting_started.md#how-to-get-coins) section to get testnet coins.

## How to start a new tapyrus network?

Tapyrus version 0.3.0 does not support setting up new secure federated networks. This section would be updated after the feature is made available in later versions. 

## How to create a genesis block?

Tapyrus-genesis utility is packaged with tapyrus v.0.3.0. It can generate a basic unsigned genesis block with block version 1. Time argument gives the block time. Aggregate public key of the Tapyrus-signer network can be given as an argument. Address is the tapyrus-address to which the block reward is paid. The output of this command is a block hex. Copy this into a file named 'genesis.dat'

Example:
``` 
./tapyrus-genesis -time=1563342688 -address=mmtAurzUTURFq9MSizWyj5sAkWzgqR8PBn -signblockpubkey=03af80b90d25145da28c583359beb47b21796b2fe1a23c1511e443e7a64dfdb27d
```

If there is a need for a custom genesis block in your test, creating and using it is not restricted. As long as the custom genesis block is signed and satisfies Tapyrus consensus rules, the block is accepted and the blockchain would progress.

## How to get coins?

Tapyrus testnet faucet can be used to get testnet coins. TODO:Add link

## How to upgrade tapyrus?

As of version 0.3.0, Tapyrus is a product under active development / testing. It is necessary to reset the network (including testnet) with each release until a network upgrade mechanism is made available in later versions. 

## What to block proof? 

Block proof is the threshold signature on every Tapyrus block. It is generated by the Tapyrus-signer network using Pedersen's verifiable secret sharing scheme.

## Further reading

1. [Strong Federations: An Interoperable Blockchain Solution to Centralized Third Party Risks](https://blockstream.com/strong-federations.pdf)
2. [Provably Secure Distributed Schnorr Signatures and a (t,n) Threshold Scheme for Implicit Cerfiticates](https://t.co/jMhQnovLcb)
